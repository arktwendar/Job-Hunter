<%
function scoreTextColor(score) {
  if (score >= 85) return 'text-emerald-700 bg-emerald-50';
  if (score >= 71) return 'text-emerald-600 bg-emerald-50';
  return 'text-gray-600 bg-gray-100';
}
function formatDate(iso) {
  if (!iso) return '—';
  return new Date(iso).toLocaleString('en-GB', { dateStyle: 'short', timeStyle: 'short' });
}
function verdictChip(verdict) {
  if (verdict === 'STRONG_MATCH')
    return '<span class="px-1.5 py-0.5 rounded text-xs font-medium bg-emerald-50 text-emerald-700 whitespace-nowrap">Strong ▾</span>';
  if (verdict === 'WEAK_MATCH')
    return '<span class="px-1.5 py-0.5 rounded text-xs font-medium bg-amber-50 text-amber-700 whitespace-nowrap">Weak ▾</span>';
  if (verdict === 'NO_MATCH')
    return '<span class="px-1.5 py-0.5 rounded text-xs font-medium bg-red-50 text-red-500 whitespace-nowrap">No match ▾</span>';
  if (verdict === 'DUPLICATE')
    return '<span class="px-1.5 py-0.5 rounded text-xs font-medium bg-purple-50 text-purple-600 whitespace-nowrap">Duplicate ▾</span>';
  if (verdict === 'BLACKLISTED')
    return '<span class="px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-500 whitespace-nowrap">Blacklisted</span>';
  return '<span class="px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-400 whitespace-nowrap">' + verdict + '</span>';
}
function qs(overrides) {
  const params = {
    verdict: filters.verdict,
    company: filters.company,
    score_min: filters.scoreMin,
    score_max: filters.scoreMax,
    date_from: filters.dateFrom,
    date_to: filters.dateTo,
    group: filters.groupId === null ? 'null' : filters.groupId,
    ...overrides
  };
  return '?' + Object.entries(params)
    .filter(([, v]) => v !== '' && v !== null && v !== undefined)
    .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
    .join('&');
}
%>

<!-- Header -->
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl font-bold text-gray-900">Jobs All</h1>
    <p class="text-sm text-gray-500 mt-1"><%= total %> job<%= total !== 1 ? 's' : '' %> stored</p>
  </div>
</div>

<!-- Filters -->
<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-5 mb-6">
  <form method="get" action="/history" class="flex flex-wrap gap-3 items-end">

    <div class="min-w-[120px]">
      <label class="block text-xs font-medium text-gray-600 mb-1">Verdict</label>
      <select name="verdict" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <option value="">All</option>
        <option value="STRONG_MATCH" <%= filters.verdict === 'STRONG_MATCH' ? 'selected' : '' %>>Strong Match</option>
        <option value="WEAK_MATCH"   <%= filters.verdict === 'WEAK_MATCH'   ? 'selected' : '' %>>Weak Match</option>
        <option value="NO_MATCH"     <%= filters.verdict === 'NO_MATCH'     ? 'selected' : '' %>>No Match</option>
        <option value="DUPLICATE"    <%= filters.verdict === 'DUPLICATE'    ? 'selected' : '' %>>Duplicate</option>
      </select>
    </div>

    <% if (groups.length > 0) { %>
    <div class="min-w-[140px]">
      <label class="block text-xs font-medium text-gray-600 mb-1">Role</label>
      <select name="group" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <option value="">All roles</option>
        <% groups.forEach(g => { %>
        <option value="<%= g.id %>" <%= filters.groupId === g.id ? 'selected' : '' %>>
          <%= g.group_name || ('Role ' + g.id) %>
        </option>
        <% }); %>
        <option value="null" <%= filters.groupId === null ? 'selected' : '' %>>Ungrouped</option>
      </select>
    </div>
    <% } %>

    <div class="min-w-[160px] flex-1">
      <label class="block text-xs font-medium text-gray-600 mb-1">Company</label>
      <input type="text" name="company" value="<%= filters.company %>"
             placeholder="Filter by company…"
             class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
    </div>

    <div class="min-w-[140px]">
      <label class="block text-xs font-medium text-gray-600 mb-1">Score range</label>
      <div class="flex gap-1.5">
        <input type="number" name="score_min" value="<%= filters.scoreMin ?? '' %>" min="0" max="100"
               class="w-full rounded-lg border border-gray-300 px-2 py-2 text-sm focus:ring-2 focus:ring-blue-500" placeholder="0" />
        <span class="self-center text-gray-400 text-xs">–</span>
        <input type="number" name="score_max" value="<%= filters.scoreMax ?? '' %>" min="0" max="100"
               class="w-full rounded-lg border border-gray-300 px-2 py-2 text-sm focus:ring-2 focus:ring-blue-500" placeholder="100" />
      </div>
    </div>

    <div class="min-w-[200px]">
      <label class="block text-xs font-medium text-gray-600 mb-1">Date range</label>
      <div class="flex gap-1.5">
        <input type="date" name="date_from" value="<%= filters.dateFrom %>"
               class="w-full rounded-lg border border-gray-300 px-2 py-2 text-xs focus:ring-2 focus:ring-blue-500" />
        <input type="date" name="date_to" value="<%= filters.dateTo %>"
               class="w-full rounded-lg border border-gray-300 px-2 py-2 text-xs focus:ring-2 focus:ring-blue-500" />
      </div>
    </div>

    <div class="flex gap-2 flex-shrink-0">
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg px-4 py-2 transition-colors">
        Filter
      </button>
      <a href="/history" class="text-center bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium rounded-lg px-4 py-2 transition-colors">
        Clear
      </a>
    </div>
  </form>
</div>

<!-- Job table -->
<div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
  <% if (jobs.length === 0) { %>
  <div class="px-6 py-16 text-center">
    <svg class="w-10 h-10 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
    <p class="text-sm text-gray-500">No jobs match your filters.</p>
  </div>
  <% } else { %>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-100">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Job</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider hidden sm:table-cell">Location</th>
          <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">Score</th>
          <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider hidden md:table-cell">Verdict</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider hidden lg:table-cell">Date</th>
          <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">Link</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-50">
        <% jobs.forEach(job => { %>
        <tr class="hover:bg-blue-50/30 transition-colors cursor-pointer" onclick="jobRowClick(event, '/job/<%= job.id %>?from=history')">
          <td class="px-6 py-4">
            <div>
              <span class="text-sm font-medium text-gray-900 line-clamp-1"><%= job.title %></span>
              <p class="text-xs text-gray-500 mt-0.5"><%= job.company %></p>
            </div>
          </td>
          <td class="px-4 py-4 text-xs text-gray-500 hidden sm:table-cell" style="width:140px;">
            <span class="line-clamp-2 leading-snug"><%= job.location || '—' %></span>
          </td>
          <td class="px-4 py-4 text-center">
            <% if (job.ai_score != null) { %>
            <span class="inline-block font-bold text-xs score-badge <%= scoreTextColor(job.ai_score) %> px-2 py-0.5 rounded">
              <%= job.ai_score %>%
            </span>
            <% } else { %>
            <span class="text-gray-300 text-xs">—</span>
            <% } %>
          </td>
          <td class="px-4 py-4 text-center hidden md:table-cell">
            <button class="verdict-btn cursor-pointer" data-job-id="<%= job.id %>" data-verdict="<%= job.is_duplicate ? 'DUPLICATE' : job.ai_verdict %>" data-chip-style="compact" title="Click to change status">
              <%- verdictChip(job.is_duplicate ? 'DUPLICATE' : job.ai_verdict) %>
            </button>
          </td>
          <td class="px-4 py-4 text-xs text-gray-400 hidden lg:table-cell whitespace-nowrap">
            <%= formatDate(job.fetched_at) %>
          </td>
          <td class="px-4 py-4 text-center">
            <% if (job.url) { %>
            <a href="<%= job.url %>" target="_blank" rel="noopener noreferrer"
               class="text-xs text-blue-500 hover:text-blue-700 font-medium hover:underline">
              View
            </a>
            <% } else { %>
            <span class="text-xs text-gray-300">—</span>
            <% } %>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <% if (totalPages > 1) { %>
  <div class="px-6 py-4 border-t border-gray-100 flex items-center justify-between">
    <p class="text-xs text-gray-500">Page <%= page %> of <%= totalPages %> · <%= total %> results</p>
    <div class="flex items-center gap-2">
      <% if (page > 1) { %>
      <a href="<%= qs({ page: page - 1 }) %>"
         class="px-3 py-1.5 text-xs font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
        ← Prev
      </a>
      <% } %>
      <% if (page < totalPages) { %>
      <a href="<%= qs({ page: page + 1 }) %>"
         class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
        Next →
      </a>
      <% } %>
    </div>
  </div>
  <% } %>
  <% } %>
</div>
