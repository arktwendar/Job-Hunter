<%
function scoreTextColor(score) {
  if (score >= 85) return 'text-emerald-700 bg-emerald-50';
  if (score >= 71) return 'text-emerald-600 bg-emerald-50';
  return 'text-gray-600 bg-gray-100';
}
function fmtDate(iso) {
  if (!iso) return '—';
  const d = new Date(String(iso).slice(0, 10) + 'T12:00:00Z');
  const dayMon = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
  return `<span style="display:block;line-height:1.4;">${dayMon}</span><span style="display:block;color:#9ca3af;line-height:1.4;">${d.getFullYear()}</span>`;
}
// Strip markdown bold markers (**text**) from AI-generated summaries
function stripMd(text) {
  if (!text) return '';
  return String(text).replace(/\*\*([^*]+)\*\*/g, '$1').replace(/\*/g, '');
}
%>

<!-- Page header -->
<div class="flex items-center justify-between mb-8">
  <div>
    <h1 class="text-2xl font-bold text-gray-900">Jobs Match</h1>
    <p class="text-sm text-gray-500 mt-1">
      All strong matches — <span class="font-medium text-gray-700"><%= total %></span> total
    </p>
  </div>
  <div class="inline-flex rounded-lg border border-gray-200 bg-white shadow-sm overflow-hidden text-sm">
    <button id="btn-date" onclick="setGrouping('date')"
            class="px-4 py-2 font-medium text-gray-700 transition-colors">By Date</button>
    <button id="btn-location" onclick="setGrouping('location')"
            class="px-4 py-2 font-medium text-gray-700 border-l border-gray-200 transition-colors">By Location</button>
  </div>
</div>

<!-- Group tabs -->
<% if (tabGroups.length > 0 || orphanCount > 0) { %>
<div class="flex gap-1 flex-wrap mb-6 border-b border-gray-200">
  <a href="/jobs"
     class="px-4 py-2 text-sm font-medium rounded-t-lg transition-colors whitespace-nowrap
            <%= (!activeGroupId && !activeOthers) ? 'bg-white border border-b-white border-gray-200 text-blue-600 -mb-px' : 'text-gray-500 hover:text-gray-700' %>">
    All <span class="text-xs text-gray-400 ml-0.5">(<%= total %>)</span>
  </a>
  <% tabGroups.forEach(g => { %>
  <a href="/jobs?group=<%= g.id %>"
     class="px-4 py-2 text-sm font-medium rounded-t-lg transition-colors whitespace-nowrap
            <%= activeGroupId === g.id ? 'bg-white border border-b-white border-gray-200 text-blue-600 -mb-px' : 'text-gray-500 hover:text-gray-700' %>">
    <%= g.group_name || ('Group ' + g.id) %> <span class="text-xs text-gray-400 ml-0.5">(<%= g.job_count %>)</span>
  </a>
  <% }); %>
  <% if (orphanCount > 0) { %>
  <a href="/jobs?group=others"
     class="px-4 py-2 text-sm font-medium rounded-t-lg transition-colors whitespace-nowrap
            <%= activeOthers ? 'bg-white border border-b-white border-gray-200 text-blue-600 -mb-px' : 'text-gray-500 hover:text-gray-700' %>">
    Others <span class="text-xs text-gray-400 ml-0.5">(<%= orphanCount %>)</span>
  </a>
  <% } %>
</div>
<% } %>

<% if (locationGroups.length === 0) { %>
<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-12 text-center">
  <svg class="w-10 h-10 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
  </svg>
  <p class="text-sm text-gray-500">No curated jobs yet. Run the pipeline to find strong matches.</p>
</div>
<% } else { %>

<%# Shared table macro — renders group headers + job rows for any groups array %>
<%
function renderTable(groups, idPrefix) {
  let html = '<div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">';
  html += '<table class="w-full" style="table-layout:fixed;">';
  html += '<colgroup>';
  html += '<col style="width:120px;">';
  html += '<col style="width:190px;">';
  html += '<col>';
  html += '<col style="width:50px;">';
  html += '<col style="width:80px;">';
  html += '<col style="width:140px;">';
  html += '<col style="width:110px;">';
  html += '<col style="width:28px;">';
  html += '</colgroup><tbody>';
  groups.forEach((group, gi) => {
    const label = group.location || group.label;
    html += `<tr class="bg-gray-50 cursor-pointer select-none" onclick="toggleGroup('${idPrefix}',${gi})">`;
    html += `<td colspan="8" class="px-5 py-3.5 ${gi > 0 ? 'border-t border-gray-200' : ''}">`;
    html += '<div class="flex items-center justify-between">';
    html += '<div class="flex items-center gap-2.5">';
    html += `<svg id="chevron-${idPrefix}-${gi}" style="width:13px;height:13px;flex-shrink:0;transform:rotate(90deg);transition:transform 0.15s;" fill="none" stroke="#9ca3af" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>`;
    html += `<span class="font-semibold text-gray-700 text-sm">${escHtml(label)}</span>`;
    html += '</div>';
    html += `<span class="text-xs text-gray-400 font-medium">${group.jobs.length} job${group.jobs.length !== 1 ? 's' : ''}</span>`;
    html += '</div></td></tr>';
    group.jobs.forEach(job => {
      html += `<tr class="job-row-${idPrefix}-${gi} border-t border-gray-100 hover:bg-blue-50/30 transition-colors cursor-pointer" onclick="jobRowClick(event, '/job/${job.id}?from=jobs')">`;
      html += `<td class="pl-5 pr-3 py-3.5 align-top" style="overflow:hidden;"><span class="text-sm font-semibold text-gray-600 leading-snug" style="display:block;word-break:break-word;">${escHtml(job.company)}</span></td>`;
      html += `<td class="px-3 py-3.5 align-top" style="overflow:hidden;"><span class="text-sm font-semibold text-gray-900 leading-snug" style="display:block;">${escHtml(job.title)}</span></td>`;
      const summary = job.ai_summary ? escHtml(stripMd(job.ai_summary)) : '<span class="text-gray-300 italic">—</span>';
      html += `<td class="px-3 py-3.5 align-top text-xs leading-relaxed text-gray-600" style="overflow:hidden;"><span style="display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;">${summary}</span></td>`;
      html += `<td class="px-3 py-3.5 text-center align-top" style="white-space:nowrap;"><span class="inline-block font-bold text-xs score-badge ${scoreTextColor(job.ai_score)} px-2 rounded">${job.ai_score}%</span></td>`;
      html += `<td class="pl-5 pr-3 py-3.5 text-xs text-gray-600 align-top font-medium">${fmtDate(job.fetched_at)}</td>`;
      const loc = job.location ? `<span class="text-xs text-gray-500 leading-snug" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${escHtml(job.location)}</span>` : '<span class="text-gray-300 text-xs">—</span>';
      html += `<td class="px-3 py-3.5 align-top">${loc}</td>`;
      const appliedClass = job.applied
        ? 'text-xs px-2 py-0.5 rounded-full bg-emerald-500 text-white border border-emerald-500 hover:bg-emerald-600 transition-colors whitespace-nowrap'
        : 'text-xs px-2 py-0.5 rounded-full border border-gray-200 text-gray-400 hover:border-gray-400 hover:text-gray-600 transition-colors whitespace-nowrap';
      const appliedLabel = job.applied ? '✓ Applied' : 'Applied';
      const noteEsc = escHtml(job.user_notes || '');
      const noteClass = job.user_notes ? 'text-amber-500 hover:text-amber-600 transition-colors' : 'opacity-20 hover:opacity-50 transition-opacity text-gray-500';
      const noteTitle = job.user_notes ? escHtml((job.user_notes.split('\n')[0] || '').slice(0, 60)) : 'Add note';
      const noteSvg = job.user_notes
        ? '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>'
        : '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>';
      html += `<td class="py-3.5 px-2 align-top">
        <div class="flex items-center gap-1.5">
          <button onclick="quickToggleApplied(event,${job.id},this)"
                  class="${appliedClass}" data-applied="${job.applied ? '1' : '0'}" style="width:76px;text-align:center;">${appliedLabel}</button>
          <button data-job-id="${job.id}" data-note="${noteEsc}" onclick="openNotePopover(event,this)"
                  class="${noteClass}" title="${noteTitle}">${noteSvg}</button>
        </div>
      </td>`;
      html += `<td class="pl-2 pr-5 py-3.5 text-center align-top" style="white-space:nowrap;">${job.url ? `<a href="${escHtml(job.url)}" target="_blank" rel="noopener noreferrer" title="View on LinkedIn" class="text-gray-300 hover:text-gray-500 text-sm">↗</a>` : '<span class="text-gray-200">—</span>'}</td>`;
      html += '</tr>';
    });
  });
  html += '</tbody></table></div>';
  return html;
}
function escHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
%>

<!-- Date-grouped view -->
<div id="view-date">
  <%- renderTable(dateGroups, 'd') %>
</div>

<!-- Location-grouped view -->
<div id="view-location" class="hidden">
  <%- renderTable(locationGroups, 'l') %>
</div>

<!-- Note popover (shared, one instance) -->
<div id="note-popover" class="hidden fixed z-50 bg-white rounded-xl shadow-xl border border-gray-200 p-3" style="width:260px;">
  <textarea id="note-text" rows="4" maxlength="5000" placeholder="Add a note…"
            class="w-full text-sm text-gray-700 border border-gray-200 rounded-lg p-2 resize-none focus:outline-none focus:border-blue-400"
            onkeydown="if(event.key==='Escape')closeNotePopover()"></textarea>
  <div class="flex justify-between items-center mt-2">
    <button onclick="clearNote()" class="text-xs text-red-400 hover:text-red-600 transition-colors">Clear</button>
    <div class="flex gap-2">
      <button onclick="closeNotePopover()" class="text-xs text-gray-400 hover:text-gray-600 transition-colors">Cancel</button>
      <button onclick="saveNote()" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition-colors">Save</button>
    </div>
  </div>
</div>

<script>
let _noteJobId = null, _noteBtn = null;

function openNotePopover(event, btn) {
  event.stopPropagation();
  _noteJobId = parseInt(btn.dataset.jobId, 10);
  _noteBtn = btn;
  const pop = document.getElementById('note-popover');
  const ta = document.getElementById('note-text');
  ta.value = btn.dataset.note || '';
  pop.classList.remove('hidden');
  // Position relative to viewport (fixed element)
  const rect = btn.getBoundingClientRect();
  const popW = 260, popH = 175;
  let left = rect.left - popW - 8;
  if (left < 8) left = Math.min(rect.right + 8, window.innerWidth - popW - 8);
  let top = rect.top;
  if (top + popH > window.innerHeight - 8) top = window.innerHeight - popH - 8;
  if (top < 8) top = 8;
  pop.style.left = left + 'px';
  pop.style.top = top + 'px';
  setTimeout(() => ta.focus(), 0);
}

function closeNotePopover() {
  document.getElementById('note-popover').classList.add('hidden');
  _noteJobId = null;
  _noteBtn = null;
}

async function saveNote() {
  const note = document.getElementById('note-text').value.trim();
  const jobId = _noteJobId;
  const btn = _noteBtn;
  closeNotePopover();
  if (!jobId) return;
  await fetch('/api/jobs/' + jobId + '/notes', {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ notes: note }),
  }).catch(() => {});
  updateNoteIcon(btn, note);
}

async function clearNote() {
  document.getElementById('note-text').value = '';
  await saveNote();
}

function updateNoteIcon(btn, note) {
  if (!btn) return;
  btn.dataset.note = note;
  const filledSvg = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>';
  const outlineSvg = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>';
  if (note) {
    btn.className = 'text-amber-500 hover:text-amber-600 transition-colors';
    btn.title = note.split('\n')[0].slice(0, 60);
    btn.innerHTML = filledSvg;
  } else {
    btn.className = 'opacity-20 hover:opacity-50 transition-opacity text-gray-500';
    btn.title = 'Add note';
    btn.innerHTML = outlineSvg;
  }
}

// Close popover on outside click
document.addEventListener('click', function(e) {
  const pop = document.getElementById('note-popover');
  if (!pop.classList.contains('hidden') && !pop.contains(e.target) && !_noteBtn?.contains(e.target)) {
    closeNotePopover();
  }
});

async function quickToggleApplied(event, jobId, btn) {
  event.stopPropagation();
  const current = btn.dataset.applied === '1';
  const next = !current;
  btn.dataset.applied = next ? '1' : '0';
  if (next) {
    btn.className = 'text-xs px-2 py-0.5 rounded-full bg-emerald-500 text-white border border-emerald-500 hover:bg-emerald-600 transition-colors whitespace-nowrap';
    btn.textContent = '✓ Applied';
  } else {
    btn.className = 'text-xs px-2 py-0.5 rounded-full border border-gray-200 text-gray-400 hover:border-gray-400 hover:text-gray-600 transition-colors whitespace-nowrap';
    btn.textContent = 'Applied';
  }
  await fetch('/api/jobs/' + jobId + '/applied', {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ applied: next }),
  }).catch(() => {});
}

function toggleGroup(prefix, gi) {
  const rows = document.querySelectorAll('.job-row-' + prefix + '-' + gi);
  const chevron = document.getElementById('chevron-' + prefix + '-' + gi);
  const isOpen = chevron.style.transform === 'rotate(90deg)';
  rows.forEach(r => r.style.display = isOpen ? 'none' : '');
  chevron.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(90deg)';
}

function setGrouping(mode) {
  document.getElementById('view-date').classList.toggle('hidden', mode !== 'date');
  document.getElementById('view-location').classList.toggle('hidden', mode !== 'location');
  const btnDate = document.getElementById('btn-date');
  const btnLoc  = document.getElementById('btn-location');
  btnDate.classList.toggle('bg-gray-100', mode === 'date');
  btnDate.classList.toggle('text-gray-900', mode === 'date');
  btnLoc.classList.toggle('bg-gray-100', mode === 'location');
  btnLoc.classList.toggle('text-gray-900', mode === 'location');
  try { localStorage.setItem('jobs-grouping', mode); } catch(_) {}
}

(function() {
  let saved = 'date';
  try { saved = localStorage.getItem('jobs-grouping') || 'date'; } catch(_) {}
  setGrouping(saved);
})();
</script>

<% } %>
